<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF Link Annotator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    .container { max-width: 800px; margin: auto; }
    canvas { display: block; margin: 10px auto; border: 1px solid #ccc; }
    .btn { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #4a5ddb; }
    input[type="file"], input[type="url"], input[type="text"] { width: 100%; margin: 5px 0 10px; padding: 8px; }
    .annotation-form, .embed-code-section { margin-top: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .embed-code { background: #eee; padding: 10px; font-family: monospace; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h1>📄 PDF Link Annotator</h1>
    <p>Upload a PDF, draw a box, and attach a link. Then embed it anywhere!</p>

    <input type="file" id="fileInput" accept="application/pdf" />

    <canvas id="pdfCanvas" style="display:none;"></canvas>

    <div class="annotation-form" id="annotationForm" style="display:none;">
      <h3>Add Link</h3>
      <input type="url" id="linkUrl" placeholder="https://example.com" required />
      <input type="text" id="linkTitle" placeholder="Link Title (optional)" />
      <button class="btn" onclick="saveAnnotation()">💾 Save</button>
      <button class="btn" onclick="cancelAnnotation()" style="background:#dc3545;">❌ Cancel</button>
    </div>

    <div class="embed-code-section" id="embedSection" style="display:none;">
      <h3>🌐 Embed Code</h3>
      <div class="embed-code" id="embedCode"></div>
      <button class="btn" onclick="copyEmbedCode()">📋 Copy</button>
    </div>
  </div>

  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    let pdfDoc = null, pageNum = 1, scale = 1.0;
    let canvas = document.getElementById('pdfCanvas');
    let ctx = canvas.getContext('2d');
    let startX, startY, endX, endY;
    let isSelecting = false;
    let selectionOverlay = null;
    let currentSelection = null;
    let annotations = [];
    let pdfBase64 = '';

    document.getElementById('fileInput').addEventListener('change', handleFile);

    function handleFile(e) {
      const file = e.target.files[0];
      if (!file || file.type !== 'application/pdf') return alert('Please upload a PDF file.');

      const reader = new FileReader();
      reader.onload = function(ev) {
        const typedarray = new Uint8Array(ev.target.result);
        loadPDF(typedarray);

        pdfBase64 = btoa(
          new Uint8Array(ev.target.result)
            .reduce((data, byte) => data + String.fromCharCode(byte), '')
        );
      };
      reader.readAsArrayBuffer(file);
    }

    async function loadPDF(data) {
      pdfDoc = await pdfjsLib.getDocument(data).promise;
      renderPage();
      canvas.style.display = 'block';
      document.getElementById('embedSection').style.display = 'block';
    }

    async function renderPage() {
      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({ scale: scale });
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      await page.render({ canvasContext: ctx, viewport: viewport }).promise;

      drawAnnotations();
    }

    function drawAnnotations() {
      annotations.forEach(a => {
        if (a.page === pageNum) {
          ctx.strokeStyle = '#667eea';
          ctx.lineWidth = 2;
          ctx.setLineDash([4, 3]);
          ctx.strokeRect(a.x, a.y, a.width, a.height);
          ctx.setLineDash([]);
        }
      });
    }

    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
      isSelecting = true;
    });

    canvas.addEventListener('mouseup', e => {
      if (!isSelecting) return;
      const rect = canvas.getBoundingClientRect();
      endX = e.clientX - rect.left;
      endY = e.clientY - rect.top;

      const width = Math.abs(endX - startX);
      const height = Math.abs(endY - startY);

      if (width > 10 && height > 10) {
        currentSelection = {
          x: Math.min(startX, endX),
          y: Math.min(startY, endY),
          width: width,
          height: height,
          page: pageNum
        };
        document.getElementById('annotationForm').style.display = 'block';
      }
      isSelecting = false;
    });

    function saveAnnotation() {
      const url = document.getElementById('linkUrl').value;
      const title = document.getElementById('linkTitle').value || 'Link';
      if (!url || !currentSelection) return alert('Please provide a valid URL');

      annotations.push({ ...currentSelection, url, title });
      document.getElementById('annotationForm').style.display = 'none';
      document.getElementById('linkUrl').value = '';
      document.getElementById('linkTitle').value = '';
      currentSelection = null;
      renderPage();
      updateEmbedCode();
    }

    function cancelAnnotation() {
      document.getElementById('annotationForm').style.display = 'none';
      currentSelection = null;
    }

    canvas.addEventListener('click', function (e) {
      if (isSelecting) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const clicked = annotations.find(a =>
        a.page === pageNum &&
        x >= a.x && x <= a.x + a.width &&
        y >= a.y && y <= a.y + a.height
      );

      if (clicked) window.open(clicked.url, '_blank');
    });

    function updateEmbedCode() {
      const embedCode = `<iframe src="data:text/html;base64,${btoa(generateEmbedHTML())}" width="800" height="600" frameborder="0"></iframe>`;
      document.getElementById('embedCode').textContent = embedCode;
    }

    function copyEmbedCode() {
      const embedCode = document.getElementById('embedCode').textContent;
      navigator.clipboard.writeText(embedCode).then(() => {
        alert('Embed code copied!');
      });
    }

    function generateEmbedHTML() {
      return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Embedded PDF</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
        <style>body { margin:0; } canvas { display:block; margin:auto; }</style>
      </head>
      <body>
        <canvas id="pdfCanvas"></canvas>
        <script>
          const annotations = ${JSON.stringify(annotations)};
          const pdfData = atob("${pdfBase64}");

          const pdfjsLib = window['pdfjs-dist/build/pdf'];
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

          const loadingTask = pdfjsLib.getDocument({ data: new Uint8Array([...pdfData].split('').map(c => c.charCodeAt(0))) });
          loadingTask.promise.then(pdf => {
            return pdf.getPage(1).then(page => {
              const scale = 1.0;
              const viewport = page.getViewport({ scale });
              const canvas = document.getElementById('pdfCanvas');
              const ctx = canvas.getContext('2d');
              canvas.width = viewport.width;
              canvas.height = viewport.height;

              return page.render({ canvasContext: ctx, viewport }).promise.then(() => {
                annotations.forEach(a => {
                  if (a.page !== 1) return;
                  ctx.strokeStyle = '#667eea';
                  ctx.lineWidth = 2;
                  ctx.setLineDash([4, 3]);
                  ctx.strokeRect(a.x, a.y, a.width, a.height);
                  ctx.setLineDash([]);
                });

                canvas.addEventListener('click', function(e) {
                  const rect = canvas.getBoundingClientRect();
                  const x = e.clientX - rect.left;
                  const y = e.clientY - rect.top;

                  const clicked = annotations.find(a =>
                    a.page === 1 &&
                    x >= a.x && x <= a.x + a.width &&
                    y >= a.y && y <= a.y + a.height
                  );

                  if (clicked) window.open(clicked.url, '_blank');
                });
              });
            });
          });
        <\/script>
      </body>
      </html>`;
    }
  </script>
</body>
</html>
